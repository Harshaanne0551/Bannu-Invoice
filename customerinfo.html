<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Dashboard - Bannu Enterprises</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Your existing CSS remains the same */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .nav-header {
      background-color: #003366;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      font-size: 24px;
    }

    .logo h1 {
      font-size: 22px;
      font-weight: 600;
    }

    .nav-links {
      display: flex;
      gap: 25px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .nav-links a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .dashboard-title {
      text-align: center;
      margin-bottom: 30px;
      color: #003366;
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      border-top: 4px solid #003366;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    .card.active {
      border-top-color: #ff9900;
      background-color: #f9f9f9;
    }

    .card-icon {
      font-size: 28px;
      margin-bottom: 15px;
      color: #003366;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #003366;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .card-description {
      font-size: 14px;
      color: #666;
    }

    .card.total-invoices {
      border-top-color: #3498db;
    }

    .card.half-amounts {
      border-top-color: #f39c12;
    }

    .card.balances {
      border-top-color: #e74c3c;
    }

    .data-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      display: none;
    }

    .data-section.active {
      display: block;
    }

    .section-title {
      font-size: 22px;
      color: #003366;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    .search-container input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }

    .search-container button {
      background-color: #003366;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .search-container button:hover {
      background-color: #002244;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #003366;
      color: white;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    .action-btn {
      padding: 6px 12px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      transition: background-color 0.3s;
      font-size: 12px;
    }

    .action-btn:hover {
      background-color: #002244;
    }

    .action-btn.edit {
      background-color: #3498db;
    }

    .action-btn.save {
      background-color: #2ecc71;
    }

    .action-btn.cancel {
      background-color: #e74c3c;
    }

    .amount-input {
      width: 80px;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: right;
      font-size: 12px;
    }

    .editable-cell {
      background-color: #fffacd;
    }

    .no-data {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #003366;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #e74c3c;
      background-color: #ffeaea;
      border-radius: 6px;
      margin: 10px 0;
    }

    .success-message {
      text-align: center;
      padding: 10px;
      color: #2ecc71;
      background-color: #e8f8ef;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }

    .debug-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 12px;
      color: #666;
    }

    @media (max-width: 768px) {
      .nav-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .nav-links {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .cards-container {
        grid-template-columns: 1fr;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .action-btn {
        padding: 4px 8px;
        font-size: 11px;
        margin-bottom: 2px;
      }
      
      .amount-input {
        width: 60px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Header -->
  <div class="nav-header">
    <div class="logo">
      <i class="fas fa-book-open"></i>
      <h1>Bannu Enterprises</h1>
    </div>
    <div class="nav-links">
      <a href="index.html">Dashboard</a>
      <a href="invoice.html">Invoice</a>
      <a href="payments.html">Payments</a>
      <a href="SearchCustomer.html">Search Customer</a>
      <a href="SearchPayments.html">Search Payments</a>
    </div>
  </div>

  <div class="container">
    <h1 class="dashboard-title">Invoice Dashboard</h1>
    
    <div class="cards-container">
      <div class="card total-invoices active" data-type="total">
        <div class="card-icon">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="card-title">Total Invoices</div>
        <div class="card-value" id="total-invoices-count">0</div>
        <div class="card-description">All customer invoices</div>
      </div>
      
      <div class="card half-amounts" data-type="partial">
        <div class="card-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="card-title">Partial Payments</div>
        <div class="card-value" id="partial-payments-count">0</div>
        <div class="card-description">Customers with partial payments</div>
      </div>
      
      <div class="card balances" data-type="balance">
        <div class="card-icon">
          <i class="fas fa-balance-scale"></i>
        </div>
        <div class="card-title">Outstanding Balances</div>
        <div class="card-value" id="balance-count">0</div>
        <div class="card-description">Bills with remaining balances</div>
      </div>
    </div>

    <div id="success-message" class="success-message"></div>
    <div id="debug-info" class="debug-info" style="display: none;"></div>
    
    <div class="data-section active" id="total-section">
      <h2 class="section-title">All Invoices</h2>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search by customer name...">
        <button id="searchBtn">Search</button>
      </div>
      <div id="total-table-container">
        <div id="total-error" class="error" style="display:none;"></div>
        <table id="total-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer Name</th>
              <th>Date</th>
              <th>Total</th>
              <th>Paid</th>
              <th>Balance</th>
              <th>Payment By</th>
              <th>Billed By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="total-table-body">
            <!-- Data will be populated here -->
          </tbody>
        </table>
        <div id="total-no-data" class="no-data" style="display:none;">
          No invoices found. Try a different search term.
        </div>
        <div id="total-loading" class="loading" style="display:none;">
          Loading invoices...
        </div>
      </div>
    </div>
    
    <div class="data-section" id="partial-section">
      <h2 class="section-title">Partial Payments</h2>
      <div class="search-container">
        <input type="text" id="partial-search-input" placeholder="Search by customer name...">
        <button id="partial-search-btn">Search</button>
      </div>
      <div id="partial-table-container">
        <div id="partial-error" class="error" style="display:none;"></div>
        <table id="partial-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer Name</th>
              <th>Date</th>
              <th>Total</th>
              <th>Paid</th>
              <th>Balance</th>
              <th>Payment By</th>
              <th>Billed By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="partial-table-body">
            <!-- Data will be populated here -->
          </tbody>
        </table>
        <div id="partial-no-data" class="no-data" style="display:none;">
          No partial payments found. Try a different search term.
        </div>
        <div id="partial-loading" class="loading" style="display:none;">
          Loading partial payments...
        </div>
      </div>
    </div>
    
    <div class="data-section" id="balance-section">
      <h2 class="section-title">Outstanding Balances</h2>
      <div class="search-container">
        <input type="text" id="balance-search-input" placeholder="Search by customer name...">
        <button id="balance-search-btn">Search</button>
      </div>
      <div id="balance-table-container">
        <div id="balance-error" class="error" style="display:none;"></div>
        <table id="balance-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer Name</th>
              <th>Date</th>
              <th>Total</th>
              <th>Paid</th>
              <th>Balance</th>
              <th>Payment By</th>
              <th>Billed By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="balance-table-body">
            <!-- Data will be populated here -->
          </tbody>
        </table>
        <div id="balance-no-data" class="no-data" style="display:none;">
          No outstanding balances found. Try a different search term.
        </div>
        <div id="balance-loading" class="loading" style="display:none;">
          Loading outstanding balances...
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const cards = document.querySelectorAll('.card');
    const dataSections = document.querySelectorAll('.data-section');
    const searchBtn = document.getElementById('searchBtn');
    
    // Global variables
    let allInvoices = [];
    let currentDisplayedData = [];
    let editingRowId = null;
    let currentTableType = 'total';
    
    // Safe element access function
    function getElementSafe(id) {
      const element = document.getElementById(id);
      if (!element) {
        console.warn(`Element with id '${id}' not found`);
      }
      return element;
    }
    
    // Safe style manipulation
    function setDisplaySafe(element, displayValue) {
      if (element && element.style) {
        element.style.display = displayValue;
      }
    }
    
    // Show debug info
    function showDebugInfo(info) {
      const debugElement = getElementSafe('debug-info');
      if (debugElement) {
        debugElement.innerHTML = `<strong>Debug Info:</strong> ${info}`;
        debugElement.style.display = 'block';
      }
    }
    
    // Show success message
    function showSuccess(message) {
      const successElement = getElementSafe('success-message');
      if (successElement) {
        successElement.textContent = message;
        successElement.style.display = 'block';
        setTimeout(() => {
          successElement.style.display = 'none';
        }, 3000);
      }
    }

    // Find original index in allInvoices array
    function findOriginalIndex(invoiceNo) {
      return allInvoices.findIndex(invoice => invoice['Invoice No'] == invoiceNo);
    }
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initialized');
      // Load all data initially
      fetchAllData();
      
      // Add event listeners to cards
      cards.forEach(card => {
        card.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          currentTableType = type;
          
          // Update active card
          cards.forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding section
          dataSections.forEach(section => section.classList.remove('active'));
          const section = getElementSafe(`${type}-section`);
          if (section) section.classList.add('active');
          
          // Load data for the selected section
          if (type === 'total') {
            currentDisplayedData = allInvoices;
            renderTable('total-table-body', allInvoices, 'total');
          } else if (type === 'partial') {
            currentDisplayedData = allInvoices.filter(invoice => 
              parseFloat(invoice.Paid || 0) > 0 && parseFloat(invoice.Balance || 0) > 0);
            renderTable('partial-table-body', currentDisplayedData, 'partial');
          } else if (type === 'balance') {
            currentDisplayedData = allInvoices.filter(invoice => parseFloat(invoice.Balance || 0) > 0);
            renderTable('balance-table-body', currentDisplayedData, 'balance');
          }
        });
      });
      
      // Add event listeners to search buttons
      if (searchBtn) {
        searchBtn.addEventListener('click', function() {
          const searchTerm = document.getElementById('searchInput').value.toLowerCase();
          currentDisplayedData = allInvoices.filter(invoice => {
            const customerName = invoice['Customer Name'] || invoice['CustomerName'] || '';
            return customerName.toLowerCase().includes(searchTerm);
          });
          renderTable('total-table-body', currentDisplayedData, 'total');
        });
      }
    });

    // Fetch all data from Google Sheets
    function fetchAllData() {
      const loadingElement = getElementSafe('total-loading');
      const errorElement = getElementSafe('total-error');
      
      setDisplaySafe(loadingElement, 'block');
      setDisplaySafe(errorElement, 'none');
      
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbz20VBaaHMqUEJZpmtlIzMw5gsRGCVFjrhRbdCN818FNUGtKUzQYoWh2Ir63ehFvEsxag/exec';
      
      console.log('Fetching all data from:', scriptUrl);
      showDebugInfo('Fetching data from: ' + scriptUrl);
      
      // Fetch all data without customer filter
      fetch(scriptUrl)
        .then(res => {
          console.log('Response status:', res.status);
          showDebugInfo(`Response status: ${res.status}`);
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('Data received:', data);
          showDebugInfo(`Received ${data ? data.length : 0} records`);
          setDisplaySafe(loadingElement, 'none');
          
          if (!data || data.length === 0) {
            const noDataElement = getElementSafe('total-no-data');
            setDisplaySafe(noDataElement, 'block');
            showDebugInfo('No data received from server');
            return;
          }
          
          // Check if data has error property
          if (data.error) {
            throw new Error(data.error);
          }
          
          allInvoices = data;
          currentDisplayedData = data;
          updateCardValues(data);
          renderTable('total-table-body', data, 'total');
          showDebugInfo(`Successfully loaded ${data.length} invoices`);
        })
        .catch(err => {
          console.error('Fetch error:', err);
          setDisplaySafe(loadingElement, 'none');
          setDisplaySafe(errorElement, 'block');
          if (errorElement) {
            errorElement.innerHTML = `Error loading data: ${err.message}`;
          }
          showDebugInfo(`Error: ${err.message}`);
        });
    }

    // Update card values with real data
    function updateCardValues(data) {
      const totalInvoices = data.length;
      const partialPayments = data.filter(invoice => 
        parseFloat(invoice.Paid || 0) > 0 && parseFloat(invoice.Balance || 0) > 0).length;
      const balanceCount = data.filter(invoice => parseFloat(invoice.Balance || 0) > 0).length;
      
      const totalInvoicesElement = getElementSafe('total-invoices-count');
      const partialPaymentsElement = getElementSafe('partial-payments-count');
      const balanceCountElement = getElementSafe('balance-count');
      
      if (totalInvoicesElement) totalInvoicesElement.textContent = totalInvoices;
      if (partialPaymentsElement) partialPaymentsElement.textContent = partialPayments;
      if (balanceCountElement) balanceCountElement.textContent = balanceCount;
      
      console.log(`Cards updated - Total: ${totalInvoices}, Partial: ${partialPayments}, Balance: ${balanceCount}`);
    }

    // Render table with data
    function renderTable(tableBodyId, data, tableType) {
      const tableBody = getElementSafe(tableBodyId);
      const noDataElement = getElementSafe(tableBodyId.replace('body', 'no-data'));
      
      if (!tableBody) return;
      
      tableBody.innerHTML = '';
      
      if (!data || data.length === 0) {
        setDisplaySafe(noDataElement, 'block');
        return;
      }
      
      setDisplaySafe(noDataElement, 'none');
      
      console.log('Rendering table with data:', data);
      
      tableBody.innerHTML = data.map((invoice, displayIndex) => {
        const invoiceNo = invoice['Invoice No'] || 'N/A';
        const customerName = invoice['Customer Name'] || 'N/A';
        const pdfLink = invoice['PDF Link'] || '';
        const total = parseFloat(invoice.Total || 0);
        const paid = parseFloat(invoice.Paid || 0);
        const balance = parseFloat(invoice.Balance || 0);
        const originalIndex = findOriginalIndex(invoiceNo);
        const rowId = `row-${tableType}-${displayIndex}`;
        
        return `
          <tr id="${rowId}">
            <td>${invoiceNo}</td>
            <td>${customerName}</td>
            <td>${invoice.Date || 'N/A'}</td>
            <td>₹${total.toLocaleString()}</td>
            <td id="paid-${tableType}-${displayIndex}">₹${paid.toLocaleString()}</td>
            <td id="balance-${tableType}-${displayIndex}">₹${balance.toLocaleString()}</td>
            <td>${invoice.PaymentBy || 'N/A'}</td>
            <td>${invoice.BilledBy || 'N/A'}</td>
            <td>
              <button class="action-btn" onclick="viewInvoice('${pdfLink}')">View</button>
              <button class="action-btn edit" onclick="enableEdit('${tableType}', ${displayIndex}, ${originalIndex})">Edit</button>
              <button class="action-btn save" onclick="saveChanges('${tableType}', ${displayIndex}, ${originalIndex})" style="display:none;">Save</button>
              <button class="action-btn cancel" onclick="cancelEdit('${tableType}', ${displayIndex})" style="display:none;">Cancel</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Enable edit mode for a row
    function enableEdit(tableType, displayIndex, originalIndex) {
      console.log('Enabling edit for:', {tableType, displayIndex, originalIndex});
      
      if (editingRowId !== null) {
        const [prevType, prevIndex] = editingRowId.split('-');
        cancelEdit(prevType, parseInt(prevIndex));
      }
      
      editingRowId = `${tableType}-${displayIndex}`;
      
      const paidCell = getElementSafe(`paid-${tableType}-${displayIndex}`);
      const balanceCell = getElementSafe(`balance-${tableType}-${displayIndex}`);
      const row = getElementSafe(`row-${tableType}-${displayIndex}`);
      
      if (!paidCell || !balanceCell || !row) {
        console.error('Could not find required elements for editing');
        return;
      }
      
      const editBtn = row.querySelector('.action-btn.edit');
      const saveBtn = row.querySelector('.action-btn.save');
      const cancelBtn = row.querySelector('.action-btn.cancel');
      
      if (paidCell && balanceCell) {
        const invoiceData = tableType === 'total' ? allInvoices[originalIndex] : currentDisplayedData[displayIndex];
        const paidValue = parseFloat(invoiceData.Paid || 0);
        const balanceValue = parseFloat(invoiceData.Balance || 0);
        
        paidCell.innerHTML = `<input type="number" class="amount-input" id="paid-input-${tableType}-${displayIndex}" value="${paidValue}" step="0.01">`;
        balanceCell.innerHTML = `<input type="number" class="amount-input" id="balance-input-${tableType}-${displayIndex}" value="${balanceValue}" step="0.01" disabled>`;
        
        paidCell.classList.add('editable-cell');
        balanceCell.classList.add('editable-cell');
        
        if (editBtn) editBtn.style.display = 'none';
        if (saveBtn) saveBtn.style.display = 'inline-block';
        if (cancelBtn) cancelBtn.style.display = 'inline-block';
        
        // Auto-update balance when paid changes
        const paidInput = getElementSafe(`paid-input-${tableType}-${displayIndex}`);
        const balanceInput = getElementSafe(`balance-input-${tableType}-${displayIndex}`);
        const total = parseFloat(invoiceData.Total || 0);
        
        if (paidInput && balanceInput) {
          paidInput.addEventListener('input', function() {
            const newPaid = parseFloat(this.value) || 0;
            const newBalance = total - newPaid;
            balanceInput.value = newBalance.toFixed(2);
          });
        }
      }
    }

    // Cancel edit mode
    function cancelEdit(tableType, displayIndex) {
      console.log('Canceling edit for:', {tableType, displayIndex});
      
      const paidCell = getElementSafe(`paid-${tableType}-${displayIndex}`);
      const balanceCell = getElementSafe(`balance-${tableType}-${displayIndex}`);
      const row = getElementSafe(`row-${tableType}-${displayIndex}`);
      
      if (!paidCell || !balanceCell || !row) return;
      
      const editBtn = row.querySelector('.action-btn.edit');
      const saveBtn = row.querySelector('.action-btn.save');
      const cancelBtn = row.querySelector('.action-btn.cancel');
      
      if (paidCell && balanceCell) {
        const invoiceData = tableType === 'total' ? allInvoices[findOriginalIndex(row.cells[0].textContent)] : currentDisplayedData[displayIndex];
        const paidValue = parseFloat(invoiceData.Paid || 0);
        const balanceValue = parseFloat(invoiceData.Balance || 0);
        
        paidCell.innerHTML = `₹${paidValue.toLocaleString()}`;
        balanceCell.innerHTML = `₹${balanceValue.toLocaleString()}`;
        
        paidCell.classList.remove('editable-cell');
        balanceCell.classList.remove('editable-cell');
        
        if (editBtn) editBtn.style.display = 'inline-block';
        if (saveBtn) saveBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';
      }
      
      if (editingRowId === `${tableType}-${displayIndex}`) {
        editingRowId = null;
      }
    }

    // Save changes to Google Sheets
    function saveChanges(tableType, displayIndex, originalIndex) {
      console.log('Saving changes for:', {tableType, displayIndex, originalIndex});
      
      const paidInput = getElementSafe(`paid-input-${tableType}-${displayIndex}`);
      const balanceInput = getElementSafe(`balance-input-${tableType}-${displayIndex}`);
      
      if (!paidInput || !balanceInput) {
        alert('Error: Could not find input fields');
        return;
      }
      
      const newPaid = parseFloat(paidInput.value) || 0;
      const newBalance = parseFloat(balanceInput.value) || 0;
      
      // Validate that Paid is not negative
      if (newPaid < 0) {
        alert('Error: Paid amount cannot be negative');
        return;
      }
      
      // Validate that Paid doesn't exceed Total
      const invoiceData = tableType === 'total' ? allInvoices[originalIndex] : currentDisplayedData[displayIndex];
      const total = parseFloat(invoiceData.Total || 0);
      if (newPaid > total) {
        alert('Error: Paid amount cannot exceed Total amount');
        return;
      }
      
      // Update local data
      const invoiceToUpdate = allInvoices[originalIndex];
      invoiceToUpdate.Paid = newPaid;
      invoiceToUpdate.Balance = newBalance;
      
      // Update Google Sheets
      updateInvoiceInSheets(invoiceToUpdate, tableType, displayIndex, originalIndex);
    }

    // Update invoice in Google Sheets
    function updateInvoiceInSheets(invoiceData, tableType, displayIndex, originalIndex) {
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbz20VBaaHMqUEJZpmtlIzMw5gsRGCVFjrhRbdCN818FNUGtKUzQYoWh2Ir63ehFvEsxag/exec';
      
      // Prepare data for update
      const updateData = {
        "Invoice No": invoiceData['Invoice No'],
        "Paid": invoiceData.Paid,
        "Total": invoiceData.Total
      };
      
      console.log('Sending update data:', updateData);
      showDebugInfo(`Updating invoice ${updateData['Invoice No']} with Paid: ${updateData.Paid}`);
      
      fetch(scriptUrl, {
        method: 'POST',
	mode:'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
      })
      .then(response => {
        console.log('Update response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Update response data:', data);
        if (data.success) {
          showSuccess('Invoice updated successfully!');
          cancelEdit(tableType, displayIndex);
          updateCardValues(allInvoices);
          showDebugInfo('Invoice successfully updated in Google Sheets');
          
          // Refresh the data to get the latest from Google Sheets
          fetchAllData();
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      })
      
    }

    // View invoice PDF
    function viewInvoice(pdfLink) {
      if (pdfLink && pdfLink !== 'N/A') {
        window.open(pdfLink, '_blank');
      } else {
        alert('No PDF available for this invoice');
      }
    }
  </script>
</body>
</html>
