<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice - Bannu Enterprises</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      font-size: 13px;
      margin: 0;
      padding: 30px;
      background: #fff;
    }

    .invoice-box {
      width: 100%;
      margin: auto;
      margin-bottom:-13px;
      border: 2px solid #000;
      padding: 20px;
      color: #000;
      height: auto;
      box-sizing: border-box;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      
      border-bottom: 1px solid #000;
      padding-bottom: 5px;
    }

    .title {
      text-align: center;
      margin-top: 10px;
    }

    .title h2 {
      margin: 5px 0;
      font-size: 20px;
      color: #003366;
      text-shadow: 0.5px 0.5px #ccc;
    }

    .title p {
      margin: 2px 0;
      font-weight: bold;
    }

    .address {
      text-align: center;
      font-size: 15px;
    }

    .info-line {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    .ms-line {
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #000;
      padding: 6px;
      text-align: center;
    }

    td input {
      width: 100%;
    }

    th:nth-child(1), td:nth-child(1) {
      width: 50%;
    }

    th:nth-child(2), td:nth-child(2) {
      width: 10%;
    }
    th:nth-child(3), td:nth-child(3) {
      width: 12%;
    }
    th:nth-child(4), td:nth-child(4) {
      width: 10%;
    }
    th:nth-child(5), td:nth-child(5) {
      width: 12%;
    }
    th:nth-child(6), td:nth-child(6) {
      width: 10%;
    }

    .totals {
      width: 50%;
      margin-left:353px;
      margin-top: -15px;
    }

    .totals table {
      border: 1px solid #000;
    }

    .totals td {
      border: 1px solid #000;
      text-align: right;
      padding: 6px 10px;
      font-family: 'Arial', sans-serif;
    }

    .total-in-words {
      margin-top: -10px;
      font-weight: bold;
      margin-left:000px;
    }

    .signature {
      margin-top: 30px;
      text-align: right;
      font-weight: bold;
    }

    input {
      border: none;
      text-align: center;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #003366;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .payment-terms {
      margin-top: 20px;
      font-size: 11px;
      
      text-align: left;
    }
    button {
      margin-top: 10px;
      padding: 3px 6px;
      background-color: #003366;
      color: white;
      border: none;
      cursor: pointer;
    }

    .tax-label {
      float: left;
    }

    .tax-controls {
      float: right;
    }

    .tax-controls button {
      font-size: 11px;
      margin-left: 5px;
      padding: 2px 6px;
      background-color: #666;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    #afterSubmitButtons {
      display: none;
    }
    .dropdown-container { position: relative; width: 100%; }
    .dropdown-list {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    .dropdown-list div {
      padding: 5px;
      cursor: pointer;
    }
    .dropdown-list div:hover {
      background-color: #f0f0f0;
    }
    .subtype-table {
      margin-top: 5px;
      font-size: 11px;
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .subtype-table td {
      padding: 2px 4px;
      text-align: center;
      width: 14.5%;
    }
    .subtype-table input {
      width: 100%;
      text-align: center;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
      text-align: center;
      vertical-align: top;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      #invoiceBox, #invoiceBox * {
        visibility: visible;
      }
      #invoiceBox {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
      .customer-name {
        font-size: 16px; 
		text-align:left;
		width:100%;/* increased */
        font-weight: bold;
	  }
	  .customer-address strong {
        font-size: 8px;   /* reduced */
        font-weight: normal;
      }
	  .customer-gst strong {
        font-size: 8px;   /* reduced */
        font-weight: normal;
      }
    /* Added for phone number field */
    #PhoneNumber {
      background-color: #f0f0f0;
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body onload="initializeInvoice()">



<div class="invoice-box" id="invoiceBox">
  <div class="top-bar">
    <div>GST No: 36AHKPA9847Q1ZI</div>
    <div>Cell: 9440607963</div>
  </div>
  <div class="title">
    <div style="background-color:#003366;color:white;display:inline-block;padding:3px 12px;font-weight:bold;border-radius:4px;">
      PERFORMA INVOICE
    </div>
    <h2>BANNU ENTERPRISES</h2>
    <p>MFGRS OF ALL TYPES OF NOTEBOOKS, LONG BOOKS, REGISTERS</p>
  </div>

  <div class="address">Sy No 22 and 23 Hythabad, Shabad Mandal, Ranga Reddy, Telangana - 509217</div>
<div class="info-line">
  <div>
    <strong>Invoice No:</strong> <span id="invoiceNo"></span><br>
    <strong>With reference to Purchase Order:</strong> IN-PO-25011532
  </div>
  <div><strong>Date:</strong> <span id="invoiceDate"></span></div>
</div>
<input
  type="text"
  id="customerName"
  value="Name: Inventre Educare Services Pvt Ltd."
  readonly
  class="customer-name"
/>



  <div class="ms-line customer-address">
  Address<br>
  <strong>
    Plot No: P-6/3,<br>
    IDA Nacharam, Road No: 15,<br>
    Hyderabad, Telangana
  </strong>
</div>
	<div class="ms-line customer-gst">
  GST No: <strong>36AAMCP1199C1ZA</strong>
</div>
  
  
  <table border="1" style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>PARTICULARS</th>
        <th>HSN</th>
        <th>Qty (Kgs)</th>
        <th>Rate</th>
        <th>Amount</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="itemRows">
      <tr>
        <td class="dropdown-container">
          <input type="text" onfocus="showDropdown(this)" oninput="filterDropdown(this)" placeholder="Select item" />
          <div class="dropdown-list"></div>
        </td>
        <td><input type="text" /></td>
        <td><input type="number" oninput="calculateRow(this)" /></td>
        <td><input type="number" oninput="calculateRow(this)" /></td>
        <td><input type="text" class="amount" readonly /></td>
        <td>
          <button onclick="this.closest('tr').remove(); updateTotals();">Remove</button>
        </td>
      </tr>
    </tbody>
  </table>
  
  <button onclick="addRow()">+ Add Row</button>
  
  <div class="totals">
    <table>
      <tr>
        <td colspan="1"><strong>GRAND TOTAL</strong></td>
        <td colspan="5"><strong>&#8377;<span id="grandTotal">0.00</span></strong></td>
      </tr>
      <tr>
        <td><strong>AMOUNT PAID</strong></td>
        <td colspan="5" style="text-align: right; font-weight: bold;">
          &#8377;<input
            type="number"
            id="amountPaid"
            value="0.00"
            oninput="updateRemainingBalance()"
            style="width: 100px; border: none; outline: none; text-align: right; font-weight: bold; font-size: 13px;"
          />
        </td>
      </tr>
      <tr>
        <td colspan="1"><strong>REMAINING BALANCE</strong></td>
        <td colspan="5"><strong>&#8377;<span id="remainingBalance">0.00</span></strong></td>
      </tr>
    </table>
  </div>
  
  <div class="total-in-words">
    Total Amount in Rs. <input type="text" id="amountInWords" readonly style="width: 100%;" />
  </div>

  <div class="payment-terms">
  <strong>Payment Terms:</strong><br>
  25% at the time of Performa Invoice<br>
  25% at the time of Delivery<br>
  50% within 90 days after Delivery
</div>
  <!-- Add this just above the billedBy div -->


  <div class="signature">For Bannu Enterprises</div>
</div>

<div style="text-align: center; margin-top: 30px;">
  <button id="submitBtn" onclick="submitInvoice()">Submit Invoice</button>
  <div id="afterSubmitButtons" style="display: none;">
    <button onclick="window.print()">Print Invoice</button>
    <button onclick="enableEditing()">Back to Edit</button>
    <button onclick="saveInvoice()">Save Invoice</button>
    <button onclick="newInvoice()">New Invoice</button>
    <button id="downloadBtn" class="no-print" onclick="downloadInvoice()">Download Invoice</button>
    <button onclick="shareInvoiceViaWhatsApp()" id="shareBtn">Share Invoice</button>
  </div>
</div>

<script>
  // Customer database with names and phone numbers
  const customerDatabase = [
  { name: "Regular Customer", phone: "", address: "Shop" },
  { name: "Bright Star School", phone: "9703362619", address: "Matkal" },
  { name: "Radiant School", phone: "9059196099", address: "Matkal" },
  { name: "Laxmi Narasimha Offset Printers", phone: "9948782019", address: "Bhongir" },
  { name: "Bala Karthikeya School", phone: "9948213889", address: "Yamzal" },
  { name: "Sanvi School", phone: "9948213889", address: "Yamzal" },
  { name: "New Madhu High School", phone: "6301369184", address: "Warasiguda" },
  { name: "S L N School", phone: "9908225584", address: "Banjara Hills" },
  { name: "Sunil", phone: "9000512686", address: "Chintal" },
  { name: "Sai Jyothi Stationary & Xerox", phone: "9542755916", address: "Badangpet" },
  { name: "kakatiya School", phone: "8019996422", address: "Uppal" },
  { name: "Sri Sai Laxmi Stationary", phone: "9347568755", address: "Sagar Ring Road" },
  { name: "Harsha School", phone: "9000143862", address: "Padmarao Nagar" },
  { name: "Basaveshwara Book Depho", phone: "9449519893", address: "Basavakalyan" },
  { name: "Kidzee", phone: "9346712762", address: "Maccha Bolarum" },
  { name: "Gouthami School", phone: "9346712762", address: "Gajularamaram" },
  { name: "Rajdhani High School", phone: "9030834500", address: "Jagadhirgutta" },
  { name: "Delhi Bazar", phone: "8466984691", address: "Aler" },
  { name: "Unique Stationary", phone: "9177806413", address: "Krishna Nagar" },
  { name: "Roja Stationary", phone: "7893756077", address: "Charminar" },
  { name: "Sri Sai Vidyanikethan High School", phone: "9391131911", address: "Moosapet" },
  { name: "Nagesh", phone: "9948333242", address: "Karwan" },
  { name: "Noble General Store", phone: "9392042012", address: "Yellareddy mandal" },
  { name: "Karnataka Book Depho", phone: "7019918040", address: "BasavaKalyan" },
  { name: "Ravi", phone: "9886919110", address: "Gajargot" },
  { name: "Sinchan Book Center", phone: "8884342415", address: "Sedam" },
  { name: "Sunrise Stationary", phone: "8686466309", address: "Karwan" },
  { name: "New Central", phone: "9949899130", address: "Meerpet" },
  { name: "Badhra", phone: "8884221618", address: "Gajargot" },
  { name: "Sandhya Book House", phone: "9342930333", address: "Raichur" },
  { name: "Chinta Sasidhar Foundation C/O Nandha Gokulam Life School", phone: "9154356060", address: "Edagali Gram Panchayat,Venkatachalam Mandal" },
  { name: "Rootz Kidz School", phone: "9652960768", address: "Kukatpally" },
  { name: "St Mary School", phone: "9515303931", address: "Dammaiguda" },
  { name: "S R Grammar School", phone: "8179828807", address: "Asif Nagar" },
  { name: "Diamond Mission High School", phone: "6305169917", address: "Bahadorpura" },
  { name: "RLGS", phone: "9441346080", address: "Kosgi" },
  { name: "Sohail Xerox", phone: "9164146485", address: "Bidar" },
  { name: "Shams Stationary", phone: "7013773090", address: "Shamshabad" },
  { name: "Swamy General Stores", phone: "9880984512", address: "Aurad" },
  { name: "Imran Xerox and Stationary", phone: "6301521940", address: "Alwal" },
  { name: "Raichur Book Center", phone: "9535155399", address: "Raichur" },
  { name: "Sai Ram Stationary", phone: "9290446503", address: "Kattedan" },
  { name: "Sharanya Stationary", phone: "8790938827", address: "Maredpally" },
  { name: "Praveen Kumar", phone: "9491564745", address: "Narayankhed" },
  { name: "Sri Laxmi Ganapathi Bangle Store", phone: "8340940538", address: "Ibrahimpatnam" },
  { name: "Praveen Stationary", phone: "8919945445", address: "Uppuguda" },
  { name: "Shivani Stationary", phone: "9885312521", address: "Near Fusion Int School Ammenpur" },
  { name: "Santoshi Matha High School", phone: "9000430567", address: "Tirumalgiri" },
  { name: "Shree Omkar Agencies", phone: "9448349495", address: "Bidar" },
  { name: "Sai Prabhu", phone: "7997165370", address: "Nijampet" },
  { name: "Times School", phone: "9966776632", address: "Haliya" },
  { name: "Genesis School", phone: "6300182192", address: "Vijaynagar Colony" },
  { name: "Charon Sai", phone: "7386289119", address: "Masab Tank" },
  { name: "Sai Baba Steel", phone: "9885146271", address: "Bijinepally" },
  { name: "S Kumar Marketing", phone: "9448947582", address: "Bidar" },
  { name: "Vasishta Stationary and BookStore", phone: "6309875854", address: "Nandipet" },
  { name: "Naresh", phone: "9951201012", address: "Mujaidpur" },
  { name: "Sri Rama Super Market", phone: "7760222500", address: "Narayanpet" },
  { name: "Gajanana Book Depho", phone: "8495079330", address: "Bhalki" },
  { name: "Shiva Book Depho", phone: "9000014326", address: "Sangareddy" },
  { name: "Quddus Stationary", phone: "7287034123", address: "NIjambad" },
  { name: "Balaji Stationary", phone: "9949242500", address: "Balapur" },
  { name: "Jaya Guru Book Stall", phone: "9242111889", address: "Yeragera" },
  { name: "Y K", phone: "9948941225", address: "Devarkonda" },
  { name: "Sree Veerabadra Stationary", phone: "9949919193", address: "Sadasivapet" },
  { name: "Manju Textiles & Stationary", phone: "9440268179", address: "" },
  { name: "Balaji (Sonu)", phone: "8187816847", address: "Rajampet" },
  { name: "Mahatma Mee Seva", phone: "9704831356", address: "Wanaparthy" },
  { name: "Hari Om", phone: "9945585148", address: "Gurumetkal" },
  { name: "Shiva Durga Traders", phone: "9010905613", address: "Nalgonda" },
  { name: "Venkat Reddy", phone: "9866166359", address: "Chevalla" },
  { name: "Sai Ram Agencies", phone: "9676286343", address: "Bachupally" },
  { name: "Manikanta Stationary", phone: "9640432737", address: "Banur" },
  { name: "V G S", phone: "8790777535", address: "Kadtal" },
  { name: "Kalyan Chakravarthy", phone: "9848591722", address: "Dilshuknagar" },
  { name: "SRK", phone: "9440760074", address: "" },
  { name: "Bana Shankari Book Stall", phone: "9945709368", address: "Gurumetkal" },
  { name: "Gayathri Stationary", phone: "9849019636", address: "Bollarum" },
  { name: "Sri Maheshwari St & Fancy", phone: "8309640143", address: "Bhongir" },
  { name: "Laxmi Venkateshwara St", phone: "9491210718", address: "Kattedan" },
  { name: "Vinayaka Online Center", phone: "8179562481", address: "Mudhol" },
  { name: "Sri Vigneshwara Super Bazar", phone: "9441432832", address: "Vanganoor" },
  { name: "Sai Laxmi Book Center", phone: "9494274545", address: "Mahaboobnagar" },
  { name: "K K R", phone: "9019690376", address: "Rangampet" },
  { name: "Aarohi Enterprises", phone: "7276861383", address: "Deagloor" },
  { name: "Rainbow Stationary", phone: "9381942479", address: "Jedcharla" },
  { name: "Noor Book Center", phone: "9866582280", address: "Kalwakurthy" },
  { name: "Sathvika Stationary", phone: "6302466194", address: "Vanasthalipuram" },
  { name: "Madhura St Vijay Love Kumar", phone: "7673933098", address: "Borabanda" },
  { name: "Naveen", phone: "9059453664", address: "" },
  { name: "Balaji Sonu", phone: "9133252423", address: "Nellore" },
  { name: "Quddus Book Depho", phone: "9849009442", address: "Nijamabad" },
  { name: "SSR Residential High School", phone: "9705898102", address: "Rajbollaram Village" },
  { name: "SB Book Stall", phone: "8149968121", address: "Degloor" },
  { name: "PSL", phone: "9676426991", address: "Shadnagar" },
  { name: "Chandana Stationary", phone: "8897635956", address: "Chintal" },
  { name: "Venkata Ramana Xerox & St", phone: "9948535393", address: "Daultabad" },
  { name: "Sri Sai Stationary", phone: "9441762283", address: "Daultabad" },
  { name: "Friends Book Store", phone: "8217040573", address: "Bidar" },
  { name: "Chakravarthy Stationary", phone: "9959230962", address: "Uppal" },
  { name: "R K Computers", phone: "9945668333", address: "Gurumetkal" },
  { name: "Sheetal Book Depho", phone: "9448947636", address: "Chittuguppa" },
  { name: "D C Kamini", phone: "9449638792", address: "Gurumetkal" },
  { name: "G. Shekar", phone: "9177378716", address: "Vikarabad" },
  { name: "Shiva Medicals & General", phone: "9740089396", address: "Hospete" },
  { name: "Venkateshwara Book Center", phone: "7795009081", address: "Gurumetkal" },
  { name: "Manjunath Computers", phone: "9901456609", address: "Chittuguppa" },
  { name: "Tirupathi General Stores", phone: "9731546902", address: "Chittugupa" },
  { name: "Sri Rama Stationary", phone: "8341446961", address: "" },
  { name: "Bhavya Stationary", phone: "9550421225", address: "JNTU" },
  { name: "Ashok Book stall", phone: "7259067754", address: "" },
  { name: "Balaji General Stores", phone: "9030609830", address: "Matkhal" },
  { name: "Sandeep", phone: "9505945923", address: "Miyapur" },
  { name: "Ambadaas", phone: "6360319343", address: "Bhalki" },
  { name: "Bhagya Laxmi Book Depho", phone: "9949009473", address: "B B Nagar" },
  { name: "Reddy General Stores", phone: "9742946430", address: "Muddhol" },
  { name: "Vijaya Sri Sai Associates", phone: "9700010268", address: "Neredmet" },
  { name: "K S", phone: "8660400665", address: "Humnabad" },
  { name: "N N T", phone: "9908486124", address: "Tandur" },
  { name: "Aashrith Enterprises", phone: "8247507429", address: "Nalgonda" },
  { name: "Rajini st", phone: "9912357593", address: "Pochampally" },
  { name: "Ashok General Stores", phone: "9182711687", address: "" },
  { name: "Sangameshwara Book Depho", phone: "7829228980", address: "Basava Kalyan" },
  { name: "Vidya Book Center", phone: "7259842347", address: "Bhalki" },
  { name: "Vivek Sports", phone: "9900636203", address: "Gurumetkal" },
  { name: "Khallil and Brothers", phone: "7795342880", address: "Chitthapur" },
  { name: "Venkateshwara Stationary", phone: "9493230563", address: "Beeramguda" },
  { name: "Trellis School", phone: "9505666606", address: "Jesus Nagar" },
  { name: "KAB", phone: "9110499105", address: "Bidar" },
  { name: "Jai Ganesh Stationary", phone: "7330574408", address: "Chintal" },
  { name: "Swamy STD", phone: "9482665676", address: "Gurumetkal" },
  { name: "Shinde Book Stall", phone: "8139931941", address: "Aurad" },
  { name: "Sri Laxmi xerox", phone: "7989471496", address: "Daultabad" },
  { name: "Nissi Book Stall", phone: "8074400422", address: "Dhone" },
  { name: "B Dhanunjaya", phone: "7207886146", address: "Gummadidala" },
  { name: "Ramu Supplier", phone: "8328005884", address: "Almasguda" },
  { name: "Veerabadra General Stores", phone: "8185857632", address: "Daultabad" },
  { name: "Manikanta Stationary", phone: "9912772369", address: "Edulabad Rd" },
  { name: "Advika Stationary", phone: "8897975535", address: "Badangpet" },
  { name: "Omkar Stationary", phone: "9948213889", address: "Yamzal" },
  { name: "Geetha Home Needs", phone: "9945922364", address: "GURUMETKAL" },
  { name: "A.R Stationary", phone: "", address: "Musheerabad" },
  { name: "Jai Hanuman Fancy Story", phone: "", address: "Ghatkesar" },
  { name: "Srikar", phone: "", address: "Naderguda" },
  { name: "Natraj", phone: "", address: "Vikarabad" },
  { name: "Mounika Stationary", phone: "", address: "Gudimalkapur" },
  { name: "Varsha Xerox", phone: "", address: "Ghatkesar" },
  { name: "Ranga Reddy", phone: "", address: "Madhapur" },
  { name: "Venkatesh General Store", phone: "", address: "Palmakul" },
  { name: "Sun Ciy Stationary", phone: "", address: "Sun City" },
  { name: "A1 Stationary", phone: "", address: "Ali cafe" },
  { name: "Sravani Stationary", phone: "", address: "Narikhuda" },
  { name: "Karnataka Book Depho", phone: "", address: "Gurmetkal" },
  { name: "Aditya Stationary", phone: "", address: "Ramanthapur" },
  { name: "Anu Stationary", phone: "", address: "Prem Nagar" },
  { name: "High Court", phone: "", address: "High Court" },
  { name: "Multi Baza", phone: "", address: "Rajendranagar" },
  { name: "Venkat Reddy", phone: "", address: "Chevella" },
  { name: "Laxmi Ganapathi stationary", phone: "", address: "Suraram" },
  { name: "Anuradha stationary", phone: "", address: "Dilshuknagar" },
  { name: "Shinchan mobile shop", phone: "", address: "Sedam" },
  { name: "Suresh supplier", phone: "", address: "Hyderabad" },
  { name: "PSL", phone: "", address: "Shadnagar" },
  { name: "Nagesh stationery", phone: "", address: "Karwan" },
  { name: "Gangadhar Ramu", phone: "", address: "Maheshwaram" },
  { name: "Ramu Gangadhar", phone: "", address: "Maheshwaram" },
  { name: "Sri rama book center", phone: "", address: "Kadtal" },
  { name: "Sai Balaji stationary", phone: "", address: "Panjagutta" },
  { name: "Durga Xerox", phone: "", address: "Moinabad" },
  { name: "Raja Saab stationary", phone: "", address: "Highcourt" },
  { name: "Laxmi Prasanna stationary", phone: "", address: "Hastinapuram" },
  { name: "Master Saab stationary", phone: "", address: "High Court" },
  { name: "Sai Kiran General store", phone: "", address: "Pochampally" },
  { name: "Shyam's stationary", phone: "", address: "Shamshabad" },
  { name: "Chandana stationary", phone: "", address: "Chintal" }
];
  let selectedBiller = '';
  let selectedPayment='';

  const particularOptions = ["Bannu King Size 112pages","Bannu King Size 160pages","Bannu King Size 176pages","Bannu King Size 184pages","Bannu King Size 192pages",
  "Naveena King Size 112pages","Naveena King Size 160pages","Naveena King Size 192pages",
  "Harsha King Size 112pages","Harsha Binding","Harsha King Size 120pages","Harsha King Size 132pages","Harsha King Size 136pages","Harsha King Size 160pages","Harsha King Size 192pages",
  "Kavitha King Size 112pages","Bannu Notebook","Harsha Notebook","Metro King Size","Divya Chetana King Size","Bannu Special Longbook",
  "Harsha Supreme","Bannu Gold","Bannu Long 160pages","Bannu Friendship","Bannu 240pages small","Bannu 320pages long","Bannu 400pages Long",
  "Bannu Jumbo 144pages","Bannu Jumbo 160pages","Bannu Jumbo 240pages","Bannu Jumbo 320pages","Bannu Jumbo 400pages",
  "Bannu A4 144pages","Bannu A4 160pages","Bannu A4 240pages","Bannu A4 320pages","Bannu A4 400pages",
  "68 Pages Long","100Pages Long",
  "A4 Graph 32pages","A4 graph 68pages","A4 graph 96pages","Drawing Book","Record 96pages","Record 144pages","Record 260pages","96 Page Practical records","144 Page Practical Record",
  "1Q Long Register","2Q Long Register","3Q Long Register","4Q Long Register","5Q Long Register","1Q Attendence Register","2Q Attendence Register","1Q Office Register","2Q Office Register",
  "1Q Short Register","2Q Short Register","3Q Short Register","4Q Short Register","5Q Short Register","1Q Cash RuleLong Register","2Q Cash Rule Long Register","3Q Cash Rule Long Register","4Q Cash Rule Long Register","5Q Cash rule Long Register","1Q Cash Rule Short Register","2Q Cash Rule Short Register","3Q Cash Rule Short Register","4Q Cash Rule Short Register","5Q Cash Rule Short Register",
  "No2 Bill Book","No3 Bill Book","No4 Bill Book","No5 Bill Book","Notepad","Graph Sheets","Maps","A4 Size Paper","King Size Loose Books","Longbook Loose Books","Exam Pads","240 Pages Rough",
  "160pages White Rough","200pages White Rough","300pages White Rough","400pages White Rough","200pages Brown Rough","300pages Brown Rough","400pages Brown Rough",
  "Color Paper","Charts","School Title Kingsize","School Title longbook","A4 Size","Bundle Charge","Citizen Binding","Title Cost","300pages Kingsize","King Size Mix","Rolls","Gift Card","Promisary Note","Bonafide Certificate","Tape 15mm x 1Mts",
                               "Tape 15mm x 2Mts","Tape 15mm x 5Mts","Tape 20mm x 1Mts","Tape 20mm x 2Mts","Tape 20mm x 5Mts","Tape 12mm x 30Mts","Tape 18mm x 30Mts","Tape 24mm x 30Mts","Tape 48mm x 30Mts Brown","Tape 48mm x 50Mts White","Tape 48mm x 50Mts Brown",
                               "Tape 72mm x 30Mts Brown","Tape 72mm x 50Mts Brown","Tape 72mm x 50Mts White","Harsha A4","Spiral 120pages Plain","Spiral 220pages Plain","Spiral 220pages S/R","Spiral 320pages Plain","Spiral 420pages Plain","Pocket Size","Finance Book","Ivory Charts","CardBoard","Dot Paper","Exam Paper","School Title Kingsize"];

  const subtypes = ["S/R", "B/R", "F/R", "D/R", "M/R", "C/R", "U/R", "O/R", "MS/R","BIG C/R"];
  const productsWithSubtypes = ["Bannu King Size 112pages","Bannu King Size 160pages","Bannu King Size 176pages","Bannu King Size 184pages","Bannu King Size 192pages",
  "Naveena King Size 112pages","Naveena King Size 160pages","Naveena King Size 192pages",
  "Harsha King Size 112pages","Harsha Binding","Harsha King Size 120pages","Harsha King Size 132pages","Harsha King Size 136pages","Harsha King Size 160pages","Harsha King Size 192pages",
  "Kavitha King Size 112pages","School Title A Grade Kingsize","Citizen Binding","Bannu Notebook","Harsha Notebook","Metro King Size","Divya Chetana King Size","School Title Kingsize"];
  
  const altSubtypesMap = {
    "King Size Mix":["B/R+M/R","C/R+F/R","Three rule+F/R","D/R+Three rule","F/R+MS/R"],
    "300pages Kingsize":["plain","S/R"],
    "Record 144pages":["Phy","Che"],
    "Record 96pages":["Phy","Che"],
    "Record 260pages":["Phy","Che"],
    "Bannu Special Longbook": ["Plain", "S/R"],
    "Bannu Gold": ["Plain", "S/R", "B/R", "O/R"],
    "Harsha Supreme": ["Plain", "S/R"],
    "Bannu Friendship": ["Plain", "S/R", "B/R", "O/R"],
    "Bannu Long 160pages": ["Plain", "S/R","B/R","O/R"],
    "Bannu 240pages small": ["Plain", "S/R"],
    "Bannu 320pages long": ["Plain", "S/R"],
    "Bannu Jumbo 144pages": ["Plain", "S/R"],
    "Bannu Jumbo 160pages": ["Plain", "S/R"],
    "Bannu Jumbo 240pages": ["Plain", "S/R"],
    "Bannu Jumbo 320pages": ["Plain", "S/R"],
    "Bannu A4 144pages": ["Plain", "S/R"],
    "Bannu A4 240pages": ["Plain", "S/R"],
    "Bannu A4 320pages": ["Plain", "S/R"],
    "White Rough 160pages":["Plain","S/R"],
    "White Rough 200pages":["Plain","S/R"],
    "White Rough 300pages":["Plain","S/R"],
    "White Rough 400pages":["Plain","S/R"],
    "A4 Size":["Plain","S/R","O/R"],
    "School Title Longbook": ["Plain", "S/R", "B/R", "O/R"],
  };

  const allProductsWithAltSubtypes = Object.keys(altSubtypesMap);

  // Customer dropdown functions
  function showCustomerDropdown() {
    const input = document.getElementById("customerName");
    const dropdown = document.getElementById("customerDropdown");
    dropdown.innerHTML = '';
    
    customerDatabase.forEach(customer => {
      const div = document.createElement("div");
      div.textContent = customer.name;
      div.onclick = () => {
        input.value = customer.name;
        document.getElementById("PhoneNumber").value = customer.phone;
        document.getElementById("Address").value = customer.address || '';
        dropdown.style.display = "none";
        document.title = `${customer.name} Invoice`;
      };
      dropdown.appendChild(div);
    });
    
    dropdown.style.display = "block";
  }

  function filterCustomerDropdown() {
    const input = document.getElementById("customerName");
    const dropdown = document.getElementById("customerDropdown");
    const filter = input.value.toLowerCase();
    
    dropdown.innerHTML = '';
    
    customerDatabase
      .filter(customer => customer.name.toLowerCase().includes(filter))
      .forEach(customer => {
        const div = document.createElement("div");
        div.textContent = customer.name;
        div.onclick = () => {
          input.value = customer.name;
          document.getElementById("PhoneNumber").value = customer.phone;
          document.getElementById("Address").value = customer.address || '';
          dropdown.style.display = "none";
          document.title = `${customer.name} Invoice`;
        };
        dropdown.appendChild(div);
      });
    
    dropdown.style.display = "block";
  }

  // Hide dropdown when clicking outside
  document.addEventListener("click", function (e) {
    if (!e.target.closest("#customerName") && !e.target.closest("#customerDropdown")) {
      document.getElementById("customerDropdown").style.display = "none";
    }
  });

  // Rest of your existing functions remain the same...
  // [All other existing functions like createDropdownCell, addRow, setBiller, showDropdown, etc.]
  
  function initializeInvoice() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = now.toLocaleString('default', { month: 'long' });
    const year = String(now.getFullYear()).slice(-2);
    const formattedDate = `${day}/${month}/${year}`;
    document.getElementById("invoiceDate").innerText = formattedDate;
  
    fetch("https://script.google.com/macros/s/AKfycbwF_ULpVqdVmws_GU5svU9SaY8K0VCZgqmOTp5HL6ARlbjIrrslO9dqRh4Jq4CBet-tAQ/exec")
      .then(response => response.json())
      .then(data => {
        let last = data.lastInvoice || "00000";
        let next = (parseInt(last, 10) + 1).toString().padStart(5, '0');
        document.getElementById("invoiceNo").innerText = next;
      })
      .catch(err => {
        console.error("Failed to fetch invoice number from Sheet:", err);
        alert("Failed to fetch invoice number. Please check your internet or try again.");
      });
  
    addRow();
  }

  function createDropdownCell() {
    const td = document.createElement('td');
    td.className = 'dropdown-container';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'particular-input';
    input.placeholder = 'Select item';
    input.addEventListener('focus', function() { showDropdown(input); });
    input.addEventListener('input', function() { filterDropdown(input); });

    const dropdown = document.createElement('div');
    dropdown.className = 'dropdown-list';

    td.appendChild(input);
    td.appendChild(dropdown);
    return td;
  }

  function addRow() {
    const row = document.createElement("tr");

    row.appendChild(createDropdownCell());

    const hsnTd = document.createElement('td');
    hsnTd.innerHTML = '<input type="text" />';
    row.appendChild(hsnTd);

    const qtyTd = document.createElement('td');
    qtyTd.innerHTML = '<input type="number" oninput="calculateRow(this)" />';
    row.appendChild(qtyTd);

    const rateTd = document.createElement('td');
    rateTd.innerHTML = '<input type="number" oninput="calculateRow(this)" />';
    row.appendChild(rateTd);

    const amountTd = document.createElement('td');
    amountTd.innerHTML = '<input type="text" class="amount" readonly />';
    row.appendChild(amountTd);

    const actionTd = document.createElement('td');
    actionTd.innerHTML = '<button onclick="this.closest(\'tr\').remove()">Remove</button>';
    row.appendChild(actionTd);

    document.getElementById("itemRows").appendChild(row);
  }

  function setBiller(name) {
    selectedBiller = name;
    document.getElementById("billerName").innerText = name;
    document.getElementById("billedBy").style.display = "block";
  }
  function setPayment(method) {
    selectedPayment = method;
    document.getElementById("paymentName").innerText = method;
    document.getElementById("paymentBy").style.display = "block";
  }


  function showDropdown(input) {
    const container = input.parentElement;
    const dropdown = container.querySelector('.dropdown-list');
    dropdown.innerHTML = '';
    particularOptions.forEach(opt => {
      const item = document.createElement('div');
      item.textContent = opt;
      item.onclick = () => {
        input.value = opt;
        dropdown.style.display = 'none';
      
        if (productsWithSubtypes.includes(opt)) {
          insertSubtypesTable(container, input);
        } else if (allProductsWithAltSubtypes.includes(opt)) {
          insertAltSubtypesTable(container, input, altSubtypesMap[opt]);
        } else {
          removeSubtypes(container);
        }
      };
      dropdown.appendChild(item);
    });

    dropdown.style.display = 'block';
  }

  function filterDropdown(input) {
    const container = input.parentElement;
    const dropdown = container.querySelector('.dropdown-list');
    const filter = input.value.toLowerCase();
    dropdown.innerHTML = '';
    particularOptions.filter(opt => opt.toLowerCase().includes(filter)).forEach(opt => {
      const item = document.createElement('div');
      item.textContent = opt;
      item.onclick = () => {
        input.value = opt;
        dropdown.style.display = 'none';
  
        if (productsWithSubtypes.includes(opt)) {
          insertSubtypesTable(container, input);
        } else if (allProductsWithAltSubtypes.includes(opt)) {
          insertAltSubtypesTable(container, input, altSubtypesMap[opt]);
        } else {
          removeSubtypes(container);
        }
      };
      dropdown.appendChild(item);
    });

    dropdown.style.display = 'block';
  }

  document.addEventListener('click', function (e) {
    if (!e.target.closest('.dropdown-container')) {
      document.querySelectorAll('.dropdown-list').forEach(dl => dl.style.display = 'none');
    }
  });

  function insertAltSubtypesTable(container, inputElement, subtypesList) {
    removeSubtypes(container);
    const table = document.createElement('table');
    table.className = 'subtype-table';

    const labelRow = document.createElement('tr');
    const inputRow = document.createElement('tr');

    subtypesList.forEach(st => {
      const labelCell = document.createElement('td');
      labelCell.textContent = st;
      labelRow.appendChild(labelCell);

      const inputCell = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = 0;
      input.oninput = () => updateQtyFromSubtypes(container);
      inputCell.appendChild(input);
      inputRow.appendChild(inputCell);
    });

    table.appendChild(labelRow);
    table.appendChild(inputRow);
    container.appendChild(table);
  }

  function insertSubtypesTable(container, inputElement) {
    removeSubtypes(container);
    const table = document.createElement('table');
    table.className = 'subtype-table';

    const row1 = document.createElement('tr');
    const row2 = document.createElement('tr');

    for (let i = 0; i < 5; i++) {
      const labelCell = document.createElement('td');
      labelCell.textContent = subtypes[i];
      row1.appendChild(labelCell);
    }
    for (let i = 0; i < 5; i++) {
      const inputCell = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = 0;
      input.oninput = () => updateQtyFromSubtypes(container);
      inputCell.appendChild(input);
      row2.appendChild(inputCell);
    }

    const row3 = document.createElement('tr');
    const row4 = document.createElement('tr');
    for (let i = 5; i < 10; i++) {
      const labelCell = document.createElement('td');
      labelCell.textContent = subtypes[i];
      row3.appendChild(labelCell);
    }
    for (let i = 5; i < 10; i++) {
      const inputCell = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = 0;
      input.oninput = () => updateQtyFromSubtypes(container);
      inputCell.appendChild(input);
      row4.appendChild(inputCell);
    }

    table.appendChild(row1);
    table.appendChild(row2);
    table.appendChild(row3);
    table.appendChild(row4);
    container.appendChild(table);
  }

  function removeSubtypes(container) {
    const existing = container.querySelector('.subtype-table');
    if (existing) existing.remove();
  }
 
  function updateQtyFromSubtypes(container) {
    const inputs = container.querySelectorAll('.subtype-table input');
    let total = 0;
    inputs.forEach(input => total += parseFloat(input.value || 0));
    const mainRow = container.closest("tr");
    const qtyInput = mainRow.children[2].querySelector("input");
    qtyInput.value = total;
    calculateRow(qtyInput);
  } 

  function submitInvoice() {
    const customerName = document.getElementById("customerName").value.trim();
    const address = document.getElementById("Address").value.trim();
  
    if (!customerName || !address) {
      alert("Please enter Customer Name and Address before submitting the invoice.");
      return;
    }
    
    document.getElementById("submitBtn").style.display = "none";
    document.getElementById("afterSubmitButtons").style.display = "block";
    document.getElementById("staffButtons").style.display = "none";
    document.getElementById("Payment-Method").style.display = "none";
    const headerRow = document.querySelector("thead tr");
    if (headerRow && headerRow.children.length === 6) {
      headerRow.removeChild(headerRow.children[5]);
    }

    const itemRows = document.querySelectorAll("#itemRows tr");
    itemRows.forEach(row => {
      if (row.children.length === 6) {
        row.removeChild(row.children[5]);
      }
    });

    document.querySelectorAll("input").forEach(input => {
      input.setAttribute("readonly", true);
    });
  }

  function enableEditing() {
    document.getElementById("submitBtn").style.display = "inline-block";
    document.getElementById("afterSubmitButtons").style.display = "none";

    document.querySelectorAll("input").forEach(input => {
      input.removeAttribute("readonly");
    });

    const headerRow = document.querySelector("thead tr");
    if (headerRow && headerRow.children.length === 5) {
      const th = document.createElement("th");
      th.textContent = "Action";
      headerRow.appendChild(th);
    }

    const rows = document.querySelectorAll("#itemRows tr");
    rows.forEach(row => {
      if (row.children.length === 5) {
        const actionTd = document.createElement("td");
        actionTd.innerHTML = '<button onclick="this.closest(\'tr\').remove(); updateTotals();">Remove</button>';
        row.appendChild(actionTd);
      }
    });
    document.getElementById("staffButtons").style.display = "block";
    if (selectedBiller) {
      document.getElementById("billerName").innerText = selectedBiller;
      document.getElementById("billedBy").style.display = "block";
    }
    document.getElementById("Payment-Method").style.display = "block";
    if (selectedPayment) {
      document.getElementById("paymentName").innerText = selectedPayment;
      document.getElementById("paymentBy").style.display = "block";
    }
  }

  function newInvoice() {
    location.reload();
  }

  function calculateRow(input) {
    const row = input.closest("tr");
    const qty = parseFloat(row.children[2].querySelector("input").value || 0);
    const rate = parseFloat(row.children[3].querySelector("input").value || 0);
    const amount = qty * rate;
    row.children[4].querySelector("input").value = formatIndianCurrency(amount);
    updateTotals();
  }

  function formatIndianCurrency(amount) {
    const parts = amount.toFixed(2).split(".");
    let num = parts[0];
    const decimalPart = parts[1];

    let lastThree = num.slice(-3);
    let rest = num.slice(0, -3);

    if (rest !== '') {
      rest = rest.replace(/\B(?=(\d{2})+(?!\d))/g, ",");
      lastThree = ',' + lastThree;
    }

    return rest + lastThree + '.' + decimalPart;
  }

  function updateTotals() {
    let subtotal = 0;
    document.querySelectorAll(".amount").forEach(input => {
      subtotal += parseFloat((input.value || "0").replace(/,/g, ""));
    });
 
    const grand = subtotal;

    document.getElementById("grandTotal").innerText = formatIndianCurrency(grand);

    const paid = parseFloat(document.getElementById("amountPaid").value || "0");
    const remaining = grand - paid;
    document.getElementById("amountInWords").value = convertNumberToWords(Math.round(remaining)) + " only";

    updateRemainingBalance();
  }

  function updateRemainingBalance() {
    let subtotal = 0;
    document.querySelectorAll(".amount").forEach(input => {
      subtotal += parseFloat((input.value || "0").replace(/,/g, ""));
    });

    const grand = subtotal;
    document.getElementById("grandTotal").innerText = formatIndianCurrency(grand);

    const paid = parseFloat(document.getElementById("amountPaid").value || "0");
    const remaining = grand - paid;

    document.getElementById("remainingBalance").innerText = formatIndianCurrency(remaining);
    document.getElementById("amountInWords").value = convertNumberToWords(Math.round(remaining)) + " only";
  }

  function displaySavedInvoices() {
    const data = JSON.parse(localStorage.getItem("savedInvoices") || "[]");
    const container = document.getElementById("savedInvoicesTable");
    container.innerHTML = '';

    if (data.length === 0) {
      container.innerHTML = "<p>No saved invoices yet.</p>";
      return;
    }

    let table = '<table border="1" cellpadding="6" cellspacing="0"><tr>';
    const headers = Object.keys(data[0]);
    headers.forEach(h => table += `<th>${h}</th>`);
    table += '</tr>';

    data.forEach(entry => {
      table += '<tr>';
      headers.forEach(h => {
        table += `<td>${entry[h]}</td>`;
      });
      table += '</tr>';
    });

    table += '</table>';
    container.innerHTML = table;
  }

  function exportToExcel() {
    const data = JSON.parse(localStorage.getItem("savedInvoices") || "[]");
    if (data.length === 0) return alert("No data to export!");

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Invoices");
    XLSX.writeFile(wb, "Saved_Invoices.xlsx");
  }

  function clearSavedInvoices() {
    if (confirm("Are you sure you want to delete all saved invoices?")) {
      localStorage.removeItem("savedInvoices");
      displaySavedInvoices();
    }
  }

  function convertNumberToWords(amount) {
    const a = [
      '', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
      'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
      'Seventeen', 'Eighteen', 'Nineteen'
    ];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

    function inWords(num) {
      if ((num = num.toString()).length > 9) return 'Overflow';
      const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
      if (!n) return;
      let str = '';
      str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + ' Crore ' : '';
      str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + ' Lakh ' : '';
      str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + ' Thousand ' : '';
      str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + ' Hundred ' : '';
      str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + ' ' : '';
      return str.trim();
    }

    return inWords(amount);
  }

  document.getElementById("customerName").addEventListener("input", function () {
    const name = this.value.trim();
    if (name) {
      document.title = `${name} Invoice`;
    } else {
      document.title = "Invoice - Bannu Enterprises";
    }
  });

  async function saveInvoice() {
    const submitBtn = document.getElementById("submitBtn");
    const invoiceNo = document.getElementById("invoiceNo").innerText.trim();
    const date = document.getElementById("invoiceDate").innerText.trim();
    const customerName = document.getElementById("customerName").value.trim();
    const address = document.getElementById("Address").value.trim();
    const amountPaid = parseFloat(document.getElementById("amountPaid").value || 0);
    
    const originalBtnText = submitBtn.innerText;
    submitBtn.innerText = "Generating PDF...";
    submitBtn.disabled = true;
    
    const loadingIndicator = document.createElement('div');
    loadingIndicator.style.position = 'fixed';
    loadingIndicator.style.top = '0';
    loadingIndicator.style.left = '0';
    loadingIndicator.style.width = '100%';
    loadingIndicator.style.height = '100%';
    loadingIndicator.style.backgroundColor = 'rgba(0,0,0,0.5)';
    loadingIndicator.style.display = 'flex';
    loadingIndicator.style.justifyContent = 'center';
    loadingIndicator.style.alignItems = 'center';
    loadingIndicator.style.zIndex = '9999';
    loadingIndicator.innerHTML = `
      <div style="background:white; padding:20px; border-radius:5px; text-align:center;">
        <div style="margin-bottom:10px;">Processing invoice, please wait...</div>
        <div class="spinner"></div>
      </div>
    `;
    document.body.appendChild(loadingIndicator);
    
    try {
      const rawRows = document.querySelectorAll("#itemRows tr");
      const validRows = [];
      let runningTotal = 0;
    
      rawRows.forEach(row => {
        const item = row.children[0]?.querySelector("input")?.value.trim();
        const qty = parseFloat(row.children[2]?.querySelector("input")?.value || 0);
        const rate = parseFloat(row.children[3]?.querySelector("input")?.value || 0);
        const amount = parseFloat((row.children[4]?.querySelector("input")?.value || "0").replace(/,/g, ""));
        
        if (item && !/^\d+$/.test(item) && qty > 0 && !isNaN(amount)) {
          runningTotal += amount;
          validRows.push({ item, qty, rate, amount });
        }
      });
    
      if (validRows.length === 0) {
        alert("No valid item rows to save.");
        return;
      }
    
      const items = validRows.map((row, index) => {
        const isLast = index === validRows.length - 1;
        return {
          InvoiceNo: invoiceNo,
          Date: date,
          CustomerName: customerName,
          Address: address,
          Item: row.item,
          Quantity: row.qty,
          Price: row.rate,
          Amount: row.amount.toFixed(2),
          GrandTotal: isLast ? runningTotal.toFixed(2) : "0.00",
          AmountPaid: isLast ? amountPaid.toFixed(2) : "0.00",
          RemainingBalance: isLast ? (runningTotal - amountPaid).toFixed(2) : "0.00",
          
        };
      });
    
      const invoiceElement = document.getElementById("invoiceBox");
      const clone = invoiceElement.cloneNode(true);
      clone.style.position = 'absolute';
      clone.style.top = '-9999px';
      clone.style.left = '0';
      clone.style.width = '794px';
      clone.style.background = '#fff';
      document.body.appendChild(clone);
    
      const pageHeight = 1122;
      const totalHeight = clone.scrollHeight;
      const numPages = Math.ceil(totalHeight / pageHeight);
    
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'px',
        format: [794, 1122],
        compress: true
      });
    
      for (let i = 0; i < numPages; i++) {
        const canvas = await html2canvas(clone, {
          scale: 1,
          useCORS: true,
          backgroundColor: "#ffffff",
          windowWidth: clone.scrollWidth,
          windowHeight: clone.scrollHeight,
          logging: false,
          ignoreElements: (el) => el.style.display === 'none' || el.classList.contains('no-print'),
          y: i * pageHeight,
          height: pageHeight,
          scrollY: -i * pageHeight
        });
    
        if (i > 0) {
          pdf.addPage([794, 1122], 'portrait');
        }
    
        pdf.addImage(canvas.toDataURL('image/jpeg', 0.85), 'JPEG', 0, 0, 794, pageHeight);
      }
    
      document.body.removeChild(clone);
    
      await fetch("https://script.google.com/macros/s/AKfycbyggO5UHpLsJMpb45GizNreGXTRyjrfH82rKFqR59gJGuPblMWTWjgMtMJiPVlSkyUtFw/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(items)
      });
    
      const pdfBlob = pdf.output('blob');
      const reader = new FileReader();
      reader.onloadend = async function() {
        const base64pdf = reader.result.split(',')[1];
        
        await fetch("https://script.google.com/macros/s/AKfycbyozn3f0q8i7CPSi6rjw0MKuF9ZsjgKjuUekPHOMW-BmQd_x-pijdJHaAoIYWPfA2Tv8w/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            invoiceNo,
            customerName,
            date,
            total: runningTotal.toFixed(2),
            paid: amountPaid.toFixed(2),
            balance: (runningTotal - amountPaid).toFixed(2),
            BilledBy: typeof selectedBiller !== 'undefined' ? selectedBiller : '',
            PaymentBy: selectedPayment || '',
            filename: `Invoice_${invoiceNo}_${customerName}.pdf`,
            pdf: base64pdf
	    
          })
        });
    
        loadingIndicator.innerHTML = `
          <div style="background:white; padding:20px; border-radius:5px; text-align:center;">
            <div style="color:green; margin-bottom:10px;"> Invoice saved successfully!</div>
            <button id="closeLoadingBtn" 
                    style="padding:5px 10px; background:#003366; color:white; border:none; cursor:pointer;">
              Close
            </button>
          </div>
        `;
        
        document.getElementById('closeLoadingBtn').addEventListener('click', function() {
          document.body.removeChild(loadingIndicator);
        });
      };
      
      reader.readAsDataURL(pdfBlob);
    
    } catch (err) {
      console.error("Error saving invoice:", err);
      loadingIndicator.innerHTML = `
        <div style="background:white; padding:20px; border-radius:5px; text-align:center;">
          <div style="color:red; margin-bottom:10px;"> Error saving invoice</div>
          <div style="font-size:12px; margin-bottom:10px;">${err.message}</div>
          <button id="closeErrorBtn" 
                  style="padding:5px 10px; background:#003366; color:white; border:none; cursor:pointer;">
            Close
          </button>
        </div>
      `;
      
      document.getElementById('closeErrorBtn').addEventListener('click', function() {
        document.body.removeChild(loadingIndicator);
      });
    } finally {
      submitBtn.innerText = originalBtnText;
      submitBtn.disabled = false;
    }
  }

  async function downloadInvoice() {
    const invoiceElement = document.getElementById("invoiceBox");

    const clone = invoiceElement.cloneNode(true);
    clone.style.position = 'fixed';
    clone.style.top = '0';
    clone.style.left = '0';
    clone.style.zIndex = '-1';
    clone.style.width = '794px';
    clone.style.background = '#fff';
    document.body.appendChild(clone);

    const canvas = await html2canvas(clone, {
      scale: 2,
      useCORS: true,
      backgroundColor: "#ffffff",
      windowWidth: clone.scrollWidth,
      windowHeight: clone.scrollHeight
    });

    document.body.removeChild(clone);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    const imgWidth = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);

    const customerName = document.getElementById("customerName").value.trim() || 'Invoice';
    const invoiceNo = document.getElementById("invoiceNo").innerText.trim() || '000';
    const fileName = `${customerName}_Invoice_${invoiceNo}.pdf`;

    pdf.save(fileName);
  }

  async function shareInvoiceViaWhatsApp() {
    const phoneNumber = document.getElementById("PhoneNumber").value.trim().replace(/\D/g, '');
    const invoiceNo = document.getElementById("invoiceNo").innerText.trim();
    const shareButton = document.getElementById("shareBtn");
    const originalText = shareButton.innerText;
    
    if (!phoneNumber || phoneNumber.length < 10) {
      alert("Please enter a valid 10-digit phone number");
      return;
    }

    if (!invoiceNo) {
      alert("Invoice number missing");
      return;
    }

    shareButton.innerText = "Processing...";
    shareButton.disabled = true;

    try {
      const response = await fetch(`https://script.google.com/macros/s/AKfycbyFtXzpIZlvv1YT_jYNcOj5Nu5KBAD2qXmAC-BoiTnzNC-UKfjDaC1aVt2NO5ARoXMH-g/exec?invoiceNo=${invoiceNo}`);
      
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const data = await response.json();
      
      if (data.error) {
        alert(`Error: ${data.error}`);
        return;
      } 
      
      if (!data.link) {
        alert("No PDF link found in response");
        return;
      }

      const customerName = document.getElementById("customerName").value.trim() || "Customer";
      
      const message = `*Bannu Enterprises Invoice* 

*Invoice No:* ${invoiceNo}
*Customer:* ${customerName}

Your invoice is ready!

 *PRESS HERE TO VIEW YOUR INVOICE:*
${data.link}

*Options:*
 Tap above link to *View* 
 Long-press to *Download*

Thank you for your business! 
*Bannu Enterprises*`;

      const whatsappUrl = `https://api.whatsapp.com/send?phone=91${phoneNumber}&text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');

    } catch (error) {
      console.error("Error sharing invoice:", error);
      alert("Failed to share invoice. Please try again or contact support.");
    } finally {
      shareButton.innerText = originalText;
      shareButton.disabled = false;
    }
  }
</script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>






